#!/bin/bash

set -euo pipefail

url=http://localhost

log() {
  local label="$1"
  local message="$2"
  echo "$label: $message"
}

login() {
  local email=
  local password=

  echo -n "email: "
  read email
  echo -n "password: "
  read -s password

  echo
  echo "logging in as $email..."
  local resp=$(curl -s -X POST "$url/sso" -d "{\"email\":\"$email\", \"plainPassword\": \"$password\"}")
  TOKEN=$(echo "$resp" | jq '.token' -r)
}

new_book() {
  local name="$1"
  local grouping="$2"

  data="{\"name\": \"$name\", \"grouping\": $grouping}"
  resp=$(curl -s -X POST "$url/api/books" -d "$data" -H "Authorization: Bearer $TOKEN")

  echo "$resp" | jq '.guid' -r
}

new_extractor() {
  local label="$1"
  local match="$2"
  local typ="$3"
  local book_guid="$4"

  data="{\"bookGuid\": \"$book_guid\", \"label\": \"$label\", \"match\": \"$match\", \"type\": $typ}"
  resp=$(curl -s -X POST "$url/api/extractors" -d "$data" -H "Authorization: Bearer $TOKEN")

  echo "$resp" | jq '.guid' -r
}

new_shorthand() {
  local priority="$1"
  local expansion="$2"
  local match="$3"
  local text="$4"
  local book_guid="$5"

  data="{\"bookGuid\": \"$book_guid\", \"priority\": $priority, \"expansion\": \"$expansion\", \"match\": \"$match\", \"text\": \"$text\"}"
  resp=$(curl -s -X POST "$url/api/shorthands" -d "$data" -H "Authorization: Bearer $TOKEN")

  echo "$resp" | jq '.guid' -r
}

new_entry() {
  local text="$1"
  local book_guid="$2"
  local created_at=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

  data="{\"guid\": \"$RANDOM\", \"bookGuid\": \"$book_guid\", \"text\": \"$text\", \"createdAt\": \"$created_at\"}"
  resp=$(curl -s -X POST "$url/api/entries" -d "$data" -H "Authorization: Bearer $TOKEN")

  echo "$resp" | jq '.entry.guid' -r
}

reset_db() {
  cleaner="truncate books; truncate collections; truncate entries; truncate extractors; truncate shorthands;"
  psql captainslog --dbname captainslog -c "$cleaner" &> /dev/null
  log "db" "reset"
}

create_workouts() {
  workouts=$(new_book "Workouts" 1)
  log "new book" "$workouts"

  (log "new extractor" $(new_extractor "exercise" '^(.+),' 0 "$workouts")) &
  (log "new extractor" $(new_extractor "sets" ',\\s{0,}(\\d+)\\s{0,}x' 1 "$workouts")) &
  (log "new extractor" $(new_extractor "reps" '\\dx\\s{0,}(\\d+)' 1 "$workouts")) &
  (log "new extractor" $(new_extractor "weight" '@\\s{0,}(\\d+(\\.\\d{1,2})?)$' 1 "$workouts")) &
  (log "new extractor" $(new_extractor "time"      '(\\d+)\\s{0,}(sec|seconds|min|minutes|hour|hours)' 1 "$workouts")) &
  (log "new extractor" $(new_extractor "time_unit" '\\d+\\s{0,}(sec|seconds|min|minutes|hour|hours)' 0 "$workouts")) &
  (log "new extractor" $(new_extractor "distance"      '(\\d+(\\.\\d+)?)\\s{0,}(mile|miles|k|kilometers)' 1 "$workouts")) &
  (log "new extractor" $(new_extractor "distance_unit" '\\d+\\s{0,}(mile|miles|k|kilometers)' 0 "$workouts")) &
  (log "new extractor" $(new_extractor "created_at" '' 1 "$workouts")) &

  (log "new shorthand" $(new_shorthand 1 "xx @ " 'xx \\d' "xx " "$workouts")) &
  (log "new shorthand" $(new_shorthand 0 "3x10" "" "xxx" "$workouts")) &
  (log "new shorthand" $(new_shorthand 0 " @ " '\\d@\\d' "@" "$workouts")) &

  wait

  # (log "new entry" $(new_entry "Bench press, xxx@65" "$workouts")) &
  # (log "new entry" $(new_entry "Squats 1, 2min" "$workouts")) &
  # (log "new entry" $(new_entry "Squats 2, xxx@45" "$workouts")) &
  # (log "new entry" $(new_entry "Squats 3, xxx 45" "$workouts")) &
  # (log "new entry" $(new_entry "Running, 30min" "$workouts")) &

  wait
}

create_blood_pressure() {
  blood_pressure=$(new_book "Blood Pressure" 0)
  log "new book" "$blood_pressure"

  (log "new extractor" $(new_extractor "a" '^(\\d+)\\s{0,}/' 1 "$blood_pressure")) &
  (log "new extractor" $(new_extractor "b" '/\\s{0,}(\\d+)' 1 "$blood_pressure")) &
  (log "new extractor" $(new_extractor "pulse" '\\(pulse (\\d+)\\)' 1 "$blood_pressure")) &
  (log "new extractor" $(new_extractor "created_at" '' 1 "$blood_pressure")) &

  wait

  # (log "new entry" $(new_entry "121 / 73 (pulse 67)" "$blood_pressure")) &
  # (log "new entry" $(new_entry "122 / 88 (pulse 80)" "$blood_pressure")) &
  # (log "new entry" $(new_entry "126 / 84 (pulse 101)" "$blood_pressure")) &
  # (log "new entry" $(new_entry "127 / 81 (pulse 85)" "$blood_pressure")) &
  # (log "new entry" $(new_entry "129 / 81 (pulse 89)" "$blood_pressure")) &
  # (log "new entry" $(new_entry "132 / 87 (pulse 74)" "$blood_pressure")) &
  # (log "new entry" $(new_entry "133 / 84 (pulse 80)" "$blood_pressure")) &
  # (log "new entry" $(new_entry "133 / 90 (pulse 83)" "$blood_pressure")) &
  # (log "new entry" $(new_entry "136 / 84 (pulse 76)" "$blood_pressure")) &

  wait
}

# reset_db
login
create_workouts &
create_blood_pressure &

wait
echo done
